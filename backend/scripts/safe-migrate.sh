#!/bin/bash

set -e

echo "=== –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–π ==="

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏
check_db_connection() {
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö..."
    local retries=30
    local count=0
    
    while [ $count -lt $retries ]; do
        if bunx prisma db execute --stdin <<< "SELECT 1;" > /dev/null 2>&1; then
            log "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
            return 0
        fi
        
        count=$((count + 1))
        log "–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è $count/$retries..."
        sleep 2
    done
    
    log "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ $retries –ø–æ–ø—ã—Ç–æ–∫"
    return 1
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π
check_migration_status() {
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π..."
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π
    local status_output
    if ! status_output=$(bunx prisma migrate status 2>&1); then
        log "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π:"
        echo "$status_output"
        return 1
    fi
    
    echo "$status_output"
    return 0
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π
safe_migrate_deploy() {
    log "–ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–π..."
    
    if bunx prisma migrate deploy; then
        log "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
        return 0
    else
        log "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –Ω–µ—É–¥–∞—á–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏
recover_failed_migration() {
    log "–ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –Ω–µ—É–¥–∞—á–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏..."
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –Ω–µ–ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—ã—Ö –º–∏–≥—Ä–∞—Ü–∏–π
    local failed_migrations
    failed_migrations=$(bunx prisma migrate status 2>&1 | grep -A 100 "Following migration" | grep -E "^\s*[0-9]" | head -1 | xargs)
    
    if [ -n "$failed_migrations" ]; then
        log "–ù–∞–π–¥–µ–Ω–∞ –Ω–µ—É–¥–∞—á–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è: $failed_migrations"
        
        # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–º–µ—Ç–∏—Ç—å –µ—ë –∫–∞–∫ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—É—é
        if bunx prisma migrate resolve --applied "$failed_migrations"; then
            log "‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è $failed_migrations –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω–∞—è"
            
            # –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –º–∏–≥—Ä–∞—Ü–∏–∏
            if bunx prisma migrate deploy; then
                log "‚úÖ –û—Å—Ç–∞–≤—à–∏–µ—Å—è –º–∏–≥—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã"
                return 0
            else
                log "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è –º–∏–≥—Ä–∞—Ü–∏–π"
                return 1
            fi
        else
            log "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–º–µ—Ç–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –∫–∞–∫ –ø—Ä–∏–º–µ–Ω—ë–Ω–Ω—É—é"
            return 1
        fi
    else
        log "–ù–µ—É–¥–∞—á–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
        return 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Prisma –∫–ª–∏–µ–Ω—Ç–∞
generate_prisma_client() {
    log "–ì–µ–Ω–µ—Ä–∞—Ü–∏—è Prisma –∫–ª–∏–µ–Ω—Ç–∞..."
    if bunx prisma generate; then
        log "‚úÖ Prisma –∫–ª–∏–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω"
        return 0
    else
        log "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ Prisma –∫–ª–∏–µ–Ω—Ç–∞"
        return 1
    fi
}

# –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞
main() {
    log "–ù–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–∏"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ä–µ–¥–µ
    local masked_url=$(echo "${DATABASE_URL:-–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω}" | sed 's/\/\/[^@]*@/\/\/***@/')
    log "DATABASE_URL: $masked_url"
    log "NODE_ENV: ${NODE_ENV:-–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω}"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –±–∞–∑–∞ –¥–ª—è —Ç–µ—Å—Ç–æ–≤
    if [[ "$DATABASE_URL" == *"localhost:5432"* ]]; then
        log "‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö"
    elif [[ "$DATABASE_URL" == *"neon.tech"* ]] || [[ "$DATABASE_URL" == *"amazonaws.com"* ]]; then
        log "‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–Ω–µ—à–Ω—è—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö"
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
    if ! check_db_connection; then
        log "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:"
        log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ PostgreSQL —Å–µ—Ä–≤–∏—Å–∞..."
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–ø—É—â–µ–Ω –ª–∏ PostgreSQL
        if command -v pg_isready >/dev/null 2>&1; then
            log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ PostgreSQL:"
            pg_isready -h localhost -p 5432 -U postgres || log "PostgreSQL –Ω–µ –≥–æ—Ç–æ–≤"
        fi
        
        log "–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ psql..."
        if command -v psql >/dev/null 2>&1; then
            # –ò–∑–≤–ª–µ–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —á–∞—Å—Ç—å URL –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è psql
            local db_url_clean=$(echo "$DATABASE_URL" | sed 's/?.*$//')
            log "–û—á–∏—â–µ–Ω–Ω—ã–π URL –¥–ª—è psql: $db_url_clean"
            psql "$db_url_clean" -c "SELECT 1;" 2>&1 || log "psql –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–∫–∂–µ –Ω–µ—É–¥–∞—á–Ω–æ"
        else
            log "psql –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        fi
        
        log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
        log "PGHOST: ${PGHOST:-–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω}"
        log "PGPORT: ${PGPORT:-–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω}"
        log "PGUSER: ${PGUSER:-–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω}"
        log "PGDATABASE: ${PGDATABASE:-–Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω}"
        
        exit 1
    fi
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º Prisma –∫–ª–∏–µ–Ω—Ç
    if ! generate_prisma_client; then
        exit 1
    fi
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π
    log "–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –º–∏–≥—Ä–∞—Ü–∏–π:"
    check_migration_status
    
    # –ü—ã—Ç–∞–µ–º—Å—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
    if safe_migrate_deploy; then
        log "üéâ –í—Å–µ –º–∏–≥—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!"
    else
        log "‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–∏ –º–∏–≥—Ä–∞—Ü–∏–π, –ø—ã—Ç–∞–µ–º—Å—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å..."
        
        if recover_failed_migration; then
            log "üéâ –ú–∏–≥—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã!"
        else
            log "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏"
            log "–î–ª—è —Ä—É—á–Ω–æ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
            log "1. bunx prisma migrate status"
            log "2. bunx prisma migrate resolve --applied <migration_name>"
            log "3. bunx prisma migrate deploy"
            exit 1
        fi
    fi
    
    # –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
    log "–§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π:"
    check_migration_status
    
    log "‚úÖ –ü—Ä–æ—Ü–µ—Å—Å –º–∏–≥—Ä–∞—Ü–∏–∏ –∑–∞–≤–µ—Ä—à—ë–Ω —É—Å–ø–µ—à–Ω–æ"
}

# –ó–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
main "$@"
