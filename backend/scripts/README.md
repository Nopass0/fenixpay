# Скрипты для безопасного применения миграций

Эта папка содержит скрипты для безопасного применения миграций Prisma, которые предотвращают проблемы при деплое в GitHub Actions.

## Файлы

### `safe-migrate.sh`
Основной скрипт для безопасного применения миграций в локальной среде и CI/CD.

**Использование:**
```bash
./scripts/safe-migrate.sh
```

**Что делает:**
1. Проверяет подключение к базе данных
2. Генерирует Prisma клиент
3. Проверяет статус миграций
4. Применяет миграции с обработкой ошибок
5. При неудаче пытается восстановить застрявшие миграции

### `docker-safe-migrate.sh`
Специализированный скрипт для применения миграций в Docker контейнерах.

**Использование:**
```bash
docker compose run --rm backend ./scripts/docker-safe-migrate.sh
```

**Что делает:**
1. Проверяет переменные окружения
2. Ждёт подключения к базе данных (с повторными попытками)
3. Генерирует Prisma клиент
4. Безопасно применяет миграции с восстановлением

## Проблемы, которые решают эти скрипты

### 1. Застрявшие миграции
Когда миграция начинается, но не завершается из-за ошибки (например, отсутствующая таблица), Prisma помечает её как "в процессе", что блокирует все последующие миграции.

**Решение:** Скрипты автоматически обнаруживают такие миграции и отмечают их как применённые с помощью `prisma migrate resolve --applied`.

### 2. Проблемы с подключением к БД
В Docker среде база данных может быть ещё не готова к подключению.

**Решение:** `docker-safe-migrate.sh` ждёт до 60 секунд, пытаясь подключиться к базе данных.

### 3. Несогласованность между средами
Разные команды в CI/CD и production могут приводить к различному состоянию базы данных.

**Решение:** Все среды теперь используют одинаковые скрипты миграции.

## Интеграция с GitHub Actions

Скрипты интегрированы в workflow файлы:

- `.github/workflows/test.yml` - использует `safe-migrate.sh`
- `.github/workflows/deploy.yml` - использует `docker-safe-migrate.sh`

## Ручное восстановление

Если автоматическое восстановление не сработало, выполните вручную:

```bash
# 1. Проверьте статус миграций
bunx prisma migrate status

# 2. Найдите застрявшую миграцию (например, 20250115_add_trader_rate_source_settings)
bunx prisma migrate resolve --applied 20250115_add_trader_rate_source_settings

# 3. Примените оставшиеся миграции
bunx prisma migrate deploy

# 4. Проверьте финальный статус
bunx prisma migrate status
```

## Логирование

Все скрипты ведут подробные логи с временными метками, что помогает отладить проблемы в CI/CD.

## Безопасность

Скрипты не выполняют деструктивных операций и не удаляют данные. Они только:
- Отмечают застрявшие миграции как применённые
- Применяют новые миграции
- Генерируют Prisma клиент

Это безопасно, если схема базы данных соответствует ожидаемому состоянию.
