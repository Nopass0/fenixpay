# Система агрегаторов ✅

## Статус: Полностью реализовано и исправлено

Система агрегаторов полностью реализована и готова к использованию. Все компоненты работают корректно.

### ✅ Последние исправления:
- Исправлена ошибка с API guard при отсутствии токена
- Исправлен поиск в транзакциях (убран mode: 'insensitive')
- Добавлены недостающие поля в ответе транзакций
- Исправлена обработка дат в dashboard/transactions

Реализована полноценная система агрегаторов для платежной платформы.

## Возможности системы

### Админка
- **Создание агрегаторов**: Генерация email, пароля и API токена
- **Управление агрегаторами**: Включение/отключение, редактирование данных
- **Мониторинг**: Просмотр статистики, транзакций и API логов
- **Безопасность**: Сброс паролей и регенерация токенов

### Личный кабинет агрегатора
- **Авторизация**: Email + пароль с поддержкой 2FA
- **Дашборд**: Статистика транзакций, баланс, недавние операции
- **API документация**: Подробное описание эндпоинтов для интеграции
- **Настройки**: Управление профилем, 2FA, смена пароля, управление токенами
- **Споры**: Система споров с мерчантами
- **Депозиты**: Пополнение USDT баланса

### API интеграция
- **Создание транзакций**: Автоматическая передача транзакций агрегаторам
- **Обновление статусов**: Колбэки от агрегаторов
- **Споры**: Создание и управление спорами через API
- **Мониторинг**: Логирование всех API вызовов

## Личный кабинет агрегатора (Frontend)

### Реализованные страницы:
- ✅ `/aggregator/login` - Страница входа с поддержкой 2FA
- ✅ `/aggregator` - Главная страница (дашборд) со статистикой
- ✅ `/aggregator/transactions` - Список транзакций
- ✅ `/aggregator/disputes` - Список споров
- ✅ `/aggregator/disputes/[id]` - Детальный просмотр спора с чатом
- ✅ `/aggregator/api-docs` - API документация
- ✅ `/aggregator/settings` - Настройки профиля, API токена, 2FA

### Функционал:
- ✅ Авторизация с 2FA через Google Authenticator
- ✅ Просмотр и копирование API токена
- ✅ Перегенерация API токена
- ✅ Пополнение баланса USDT (модальное окно)
- ✅ Настройка базового URL для колбэков
- ✅ Управление 2FA (включение/отключение)
- ✅ Смена пароля
- ✅ Управление сессиями
- ✅ Просмотр транзакций с фильтрацией
- ✅ Участие в спорах (чат с мерчантом)
- ✅ Полная API документация с примерами

## Структура базы данных

Добавлены следующие модели:
- `Aggregator` - основная модель агрегатора
- `AggregatorSession` - сессии агрегаторов
- `AggregatorDispute` - споры агрегаторов
- `AggregatorDisputeMessage` - сообщения в спорах
- `AggregatorApiLog` - логи API вызовов

## API эндпоинты для агрегаторов

### Что должны реализовать агрегаторы:

1. **POST /transaction/create**
   - Создание транзакции на стороне агрегатора
   - Возврат реквизитов для оплаты

2. **POST /transaction/status**
   - Обновление статуса транзакции

3. **GET /transaction/:id**
   - Получение информации о транзакции

4. **POST /callback**
   - Получение колбэков от нашей системы

### Что предоставляет наша система:

1. **POST /api/aggregator/callback**
   - Прием колбэков от агрегаторов
   - Обновление статусов транзакций
   - Создание споров

## Поток работы

1. **Мерчант создает транзакцию** через наше API
2. **Система ищет трейдера** с подходящими реквизитами
3. **Если трейдер не найден**, система обращается к агрегаторам
4. **Агрегатор обрабатывает** транзакцию и возвращает реквизиты
5. **Мерчант получает ответ** с реквизитами от агрегатора
6. **Агрегатор уведомляет** нас об изменении статуса
7. **Мы отправляем колбэк** мерчанту

## Константы и справочники

Система предоставляет агрегаторам:
- Типы банков (`BankType`)
- Типы методов платежа (`MethodType`)
- Статусы транзакций (`Status`)
- Поддерживаемые валюты (`Currency`)

## Безопасность

- **API токены**: Уникальные токены для каждого агрегатора
- **2FA**: Двухфакторная аутентификация через Google Authenticator
- **Сессии**: Управление активными сессиями
- **Логирование**: Полное логирование всех API вызовов

## Мониторинг

- **Статистика**: Детальная статистика по транзакциям и спорам
- **API логи**: Логирование всех запросов с временем выполнения
- **Уведомления**: Система уведомлений об ошибках и проблемах

## Финансы

- **Депозиты**: Агрегаторы могут пополнять USDT баланс
- **Автоматическое списание**: При успешных транзакциях
- **Контроль лимитов**: Проверка достаточности средств

## Использование

### Для админов:
1. Перейти в `/api/admin/aggregators`
2. Создать нового агрегатора
3. Настроить параметры и активировать

### Для агрегаторов:
1. Получить данные для входа от админа
2. Войти в систему по адресу `/api/aggregator/auth/login`
3. Настроить 2FA в разделе настроек
4. Изучить API документацию
5. Реализовать необходимые эндпоинты
6. Настроить базовый URL API

### Для разработчиков:
- Все маршруты задокументированы в Swagger
- Система поддерживает полную интеграцию
- Подробные логи для отладки

## Последние исправления

- Исправлена обработка дат в dashboard/transactions
- Исправлена проблема с сохранением сессии агрегатора
- Удален лишний параметр token из aggregator store
- Создан отдельный hook useAggregatorHydrated для правильной гидратации
- Добавлены отладочные страницы /aggregator/debug и /aggregator/test-store
- Добавлено логирование в backend middleware и frontend API interceptors
- Создана страница /aggregator/test-api для тестирования API вызовов

## Отладка проблем с авторизацией

Если возникают проблемы с авторизацией агрегатора:

1. **Откройте консоль браузера (F12)** для просмотра логов
2. **Перейдите на `/aggregator/test-api`** для тестирования API
3. **Проверьте логи backend** в консоли где запущен сервер
4. **Используйте `/aggregator/clear-storage`** для очистки старых данных

### Логи для отладки:
- `[Aggregator API] Request interceptor` - показывает отправляемые запросы
- `[Aggregator API] Response error` - показывает ошибки от сервера
- `[Auth]` - логи создания сессии на backend
- `[AggregatorGuard]` - логи проверки сессии на backend

## Тестовые учетные данные

### Агрегатор 1:
- Email: `ag@ag.com`
- Password: нужно узнать у администратора
- Name: AgTest

### Агрегатор 2 (тестовый):
- Email: `test@aggregator.com`
- Password: `Test123!`
- Name: Test Aggregator
- Balance: 10000 USDT

### Страницы для тестирования:
- `/aggregator/quick-login` - быстрый вход с предзаполненными данными
- `/aggregator/test-api` - тестирование API вызовов
- `/aggregator/test-store` - проверка работы store
- `/aggregator/debug` - отладочная информация