# Оптимизация таймаутов для быстрых запросов (≤ 2 секунды)

## Обзор изменений

Система была оптимизирована для обеспечения быстрых ответов от агрегаторов не более чем за 2 секунды.

## Внесенные изменения

### 1. Обновлены настройки агрегаторов
- **maxSlaMs**: Установлен в 2000ms (2 секунды) для всех агрегаторов
- **Quattrex**: Обновлен с 60000ms до 2000ms
- **Все активные агрегаторы**: Приведены к стандарту 2000ms

### 2. Обновлены сервисы

#### AggregatorService
- Заменены жестко заданные таймауты 30000ms на `aggregator.maxSlaMs || 2000`
- Все запросы теперь используют настройки из базы данных

#### PSPWareAdapterService
- Обновлен таймаут с 10000ms до 2000ms
- Ускорена обработка PSPWare запросов

#### ChaseAdapterService
- Унифицирован таймаут до 2000ms для всех типов запросов
- Убраны различия между Chase-совместимыми и обычными агрегаторами

#### AggregatorQueueService
- Уже использовал настройки агрегатора (maxSlaMs)
- Fallback механизм работает с новыми таймаутами

#### AggregatorV2Service
- Уже использовал настройки агрегатора (maxSlaMs)
- Совместим с новыми настройками

### 3. Обновлена схема базы данных
- **maxSlaMs**: По умолчанию 2000ms для новых агрегаторов
- Добавлен комментарий о 2-секундном лимите

## Результаты тестирования

### Тест с Quattrex агрегатором
```
Таймаут: 2000ms
Результат: timeout of 2000ms exceeded (2143ms)
Статус: ✅ Работает корректно - агрегатор превышает лимит
```

### Ожидаемое поведение
1. **Быстрые агрегаторы** (≤ 2000ms): Запросы проходят успешно
2. **Медленные агрегаторы** (> 2000ms): Автоматический fallback на следующий агрегатор
3. **SLA нарушения**: Логируются в AggregatorIntegrationLog

## Преимущества

### 1. Быстрая обработка
- Все запросы обрабатываются за ≤ 2 секунд
- Улучшенный пользовательский опыт
- Снижена нагрузка на систему

### 2. Автоматический fallback
- Медленные агрегаторы автоматически исключаются
- Система переключается на быстрые альтернативы
- Высокая доступность сервиса

### 3. Мониторинг
- Все нарушения SLA логируются
- Статистика по производительности агрегаторов
- Возможность настройки индивидуальных таймаутов

## Настройка индивидуальных таймаутов

Для агрегаторов, которые могут работать быстрее или медленнее:

```sql
-- Для очень быстрого агрегатора (1 секунда)
UPDATE "Aggregator" SET "maxSlaMs" = 1000 WHERE id = 'aggregator_id';

-- Для медленного, но надежного агрегатора (5 секунд)
UPDATE "Aggregator" SET "maxSlaMs" = 5000 WHERE id = 'aggregator_id';
```

## Мониторинг производительности

### Проверка логов SLA
```typescript
const slaViolations = await prisma.aggregatorIntegrationLog.findMany({
  where: {
    slaViolation: true,
    createdAt: { gte: new Date(Date.now() - 24 * 60 * 60 * 1000) }
  },
  include: { aggregator: true }
});
```

### Статистика по агрегаторам
```typescript
const stats = await prisma.aggregatorIntegrationLog.groupBy({
  by: ['aggregatorId'],
  where: { eventType: 'deal_create' },
  _avg: { responseTimeMs: true },
  _count: { slaViolation: true }
});
```

## Рекомендации

1. **Мониторинг**: Регулярно проверяйте логи на нарушения SLA
2. **Настройка**: Адаптируйте таймауты под возможности каждого агрегатора
3. **Fallback**: Убедитесь, что есть быстрые альтернативы
4. **Алерты**: Настройте уведомления при частых нарушениях SLA

## Обратная совместимость

- Все существующие агрегаторы обновлены до 2000ms
- Система продолжает работать с индивидуальными настройками
- Fallback механизм сохранен и улучшен
