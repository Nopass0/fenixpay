# Пайплайн миграций базы данных

## Обзор

Этот документ описывает надежный пайплайн для управления миграциями базы данных в проекте Chase. Пайплайн обеспечивает безопасное применение миграций в различных окружениях без потери данных.

## Структура пайплайна

### 1. Скрипты

#### `scripts/migration-pipeline.ts`
Основной скрипт для синхронизации и применения миграций:
- Проверяет статус миграций
- Создает недостающие миграции
- Применяет ожидающие миграции
- Проверяет схему базы данных

#### `scripts/deploy-migrations.sh`
Bash скрипт для деплоя миграций:
- Проверяет подключение к БД
- Создает бэкапы (для продакшена)
- Синхронизирует миграции
- Применяет новые миграции
- Проверяет схему
- Генерирует Prisma клиент

### 2. Docker

#### `Dockerfile.migrations`
Docker образ для выполнения миграций в контейнере.

#### `docker-compose.migrations.yml`
Docker Compose конфигурация для запуска миграций с PostgreSQL.

### 3. CI/CD

#### `.github/workflows/migrations.yml`
GitHub Actions workflow для автоматического тестирования и деплоя миграций.

## Использование

### Локальная разработка

```bash
# Проверить статус миграций
npm run db:status

# Синхронизировать миграции
npm run db:sync

# Применить миграции
npm run db:deploy

# Создать новую миграцию
npm run db:migrate

# Сбросить миграции (только dev)
npm run db:migrate:reset
```

### Продакшен

```bash
# Деплой в продакшен
npm run db:deploy:prod

# Проверить статус
./scripts/deploy-migrations.sh production status
```

### Docker

```bash
# Запустить миграции в контейнере
docker-compose -f docker-compose.migrations.yml up migrations

# Только проверить статус
docker-compose -f docker-compose.migrations.yml run migrations ./scripts/deploy-migrations.sh production status
```

## Безопасность

### Автоматические проверки

1. **Подключение к БД**: Проверяется перед началом работы
2. **Статус миграций**: Проверяется соответствие локальных и БД миграций
3. **Схема БД**: Проверяется соответствие схемы Prisma
4. **Бэкапы**: Автоматически создаются для продакшена

### Обработка ошибок

1. **Неудачные миграции**: Автоматически помечаются как примененные
2. **Конфликты**: Разрешаются через синхронизацию
3. **Откат**: Доступен только для разработки

## Мониторинг

### Логи

Все операции логируются с временными метками:
- ✅ Успешные операции
- ⚠️ Предупреждения
- ❌ Ошибки

### Статус миграций

```bash
# Проверить статус
npx prisma migrate status

# Посмотреть историю
npx prisma migrate status --verbose
```

## Устранение проблем

### Проблема: Миграции не синхронизированы

```bash
# Решение: Синхронизировать миграции
npm run db:sync
```

### Проблема: Неудачная миграция

```bash
# Решение: Пометить как примененную
npx prisma migrate resolve --applied "migration_name"

# Или откатить
npx prisma migrate resolve --rolled-back "migration_name"
```

### Проблема: Схема не соответствует

```bash
# Решение: Синхронизировать схему
npx prisma db pull
npx prisma generate
```

## Лучшие практики

### 1. Разработка миграций

- Всегда тестируйте миграции локально
- Используйте `npm run db:migrate` для создания миграций
- Проверяйте SQL перед коммитом
- Добавляйте комментарии к миграциям

### 2. Деплой

- Никогда не деплойте миграции напрямую в продакшен
- Используйте CI/CD пайплайн
- Создавайте бэкапы перед деплоем
- Тестируйте на dev окружении

### 3. Мониторинг

- Проверяйте статус миграций после деплоя
- Мониторьте логи приложения
- Отслеживайте производительность БД

## Структура файлов

```
backend/
├── prisma/
│   ├── migrations/           # Файлы миграций
│   └── schema.prisma         # Схема Prisma
├── scripts/
│   ├── migration-pipeline.ts # Основной скрипт
│   └── deploy-migrations.sh  # Bash скрипт деплоя
├── Dockerfile.migrations     # Docker образ
├── docker-compose.migrations.yml
└── MIGRATION_PIPELINE.md     # Эта документация
```

## Переменные окружения

### Обязательные

- `DATABASE_URL` - URL подключения к базе данных

### Опциональные

- `NODE_ENV` - Окружение (development/production)
- `POSTGRES_DB` - Имя базы данных
- `POSTGRES_USER` - Пользователь БД
- `POSTGRES_PASSWORD` - Пароль БД

## Поддержка

При возникновении проблем:

1. Проверьте логи: `npm run db:status`
2. Синхронизируйте миграции: `npm run db:sync`
3. Проверьте подключение к БД
4. Обратитесь к документации Prisma

## Заключение

Этот пайплайн обеспечивает надежное и безопасное управление миграциями базы данных. Следуйте лучшим практикам и используйте автоматизированные инструменты для минимизации рисков.

