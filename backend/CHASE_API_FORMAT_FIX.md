# Исправление формата запроса для Chase-совместимых агрегаторов

## Проблема
API запросы к Chase-совместимым агрегаторам возвращали ошибку 401 из-за неправильного формата запроса.

## Анализ
Сравнивая наш запрос с документацией API, были найдены следующие несоответствия:

### Неправильный формат (до исправления):
```json
{
  "rate": 85.24,
  "amount": 1000,
  "isMock": true,  // ❌ Лишнее поле
  "userIp": "127.0.0.1",
  "orderId": "mock-1757526448014-dstuus",
  "methodId": "cmf9y824y08spikmk4k0rcqs6",  // ❌ Неправильный формат
  "expired_at": "2025-09-10T18:17:28.014Z",
  "callbackUri": "https://api.chase.com/api/aggregator/chase-callback/cmfdynee902gmikvwlqtn1je1",  // ❌ Неправильный URL
  "clientIdentifier": "test-client"  // ❌ Неправильный формат
}
```

### Правильный формат (после исправления):
```json
{
  "amount": 8198,
  "orderId": "test-curl-129",
  "methodId": "method_1a2b3c4d5e6f",  // ✅ Правильный формат
  "rate": 97.57222505486517,
  "expired_at": "2025-09-11T17:38:33.159Z",
  "userIp": "85.73.129.5",
  "callbackUri": "https://example.com/callback",  // ✅ Правильный URL
  "clientIdentifier": "client_user_12345"  // ✅ Правильный формат
}
```

## Внесенные изменения

### 1. AggregatorServiceV2.sendMockDeal()
- **Убрано поле `isMock`** - не поддерживается API
- **Исправлен `methodId`** - используется формат `method_1a2b3c4d5e6f`
- **Исправлен `clientIdentifier`** - используется формат `client_user_12345`
- **Исправлен `callbackUri`** - используется `http://localhost:3000` вместо `https://api.chase.com`

### 2. AggregatorQueueService.sendDealToAggregator()
- **Убрано поле `isMock`** - не поддерживается API
- **Исправлен `methodId`** - используется правильный формат
- **Исправлен `clientIdentifier`** - используется правильный формат
- **Добавлены значения по умолчанию** для `userIp` и `clientIdentifier`

### 3. Обработка ошибок
- **Улучшена обработка ошибок** - теперь правильно извлекается код ошибки из тела ответа
- **Добавлена отладочная информация** для диагностики проблем

## Результаты тестирования

### ✅ Исправленный формат запроса
- **Все поля соответствуют API документации**
- **Убраны лишние поля** (`isMock`)
- **Исправлены форматы полей** (`methodId`, `clientIdentifier`)
- **Правильный URL callback** (`http://localhost:3000`)

### ❌ Оставшаяся проблема
- **Ошибка 401** - проблема с авторизацией на стороне сервера
- **Сообщение `"[object Object]"`** - сервер неправильно сериализует ошибку

## Возможные причины ошибки 401

1. **Неверный токен** - токен в базе данных не соответствует реальному токену на сервере
2. **Проблема с сервером** - сервер quattrex.pro может не работать корректно
3. **Неправильная авторизация** - сервер может ожидать другой формат заголовков

## Рекомендации

1. **Проверить токен** - убедиться, что токен в базе данных соответствует реальному токену
2. **Связаться с администратором сервера** - проверить статус сервера quattrex.pro
3. **Проверить документацию API** - убедиться, что формат авторизации правильный

## Преимущества исправления

### 1. Соответствие API документации
- Все поля запроса соответствуют ожидаемому формату
- Убраны лишние поля, которые не поддерживаются API

### 2. Улучшенная диагностика
- Правильное отображение кода ошибки (401 вместо 500)
- Подробная отладочная информация для диагностики

### 3. Готовность к продакшену
- Формат запроса готов для использования с реальными агрегаторами
- Правильная обработка ошибок для мониторинга
